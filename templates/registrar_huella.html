<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrar Huella</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #0b0b0b;
      font-family: 'Orbitron', sans-serif;
      color: #fff;
      text-align: center;
      padding-top: 50px;
    }
    .card {
      background: rgba(10, 10, 20, 0.85);
      border-radius: 20px;
      padding: 30px;
      margin: auto;
      max-width: 500px;
      box-shadow: 0 0 35px #00ffe7, 0 0 60px #0066ff;
    }
    .btn-futuristic {
      background: linear-gradient(45deg, #00ffe7, #0066ff);
      color: #fff;
      font-weight: bold;
      border-radius: 50px;
      box-shadow: 0 0 15px #00ffe7;
      transition: all 0.3s ease;
    }
    .btn-futuristic:hover {
      transform: scale(1.05);
      box-shadow: 0 0 40px #00ffe7, 0 0 70px #0066ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2 class="mb-4">üîí Registro de Huella</h2>
      <p>Bienvenido <strong>{{ usuario }}</strong>. Coloca tu huella para registrarla.</p>

      <button id="btnEscanear" class="btn btn-futuristic mt-3">
        <i class="bi bi-fingerprint"></i> Escanear Huella
      </button>

      <!-- üîë Importante: attestationObject y credential_id -->
      <form id="formHuella" method="POST" style="display: none;">
        <input type="hidden" name="credential_id" id="inputCredential">
        <input type="hidden" name="attestationObject" id="inputAttestation">
        <input type="hidden" name="sign_count" id="inputSignCount" value="0">

        <button type="submit" class="btn btn-futuristic mt-3">
          Guardar Huella
        </button>
      </form>

      <div id="alerta" class="mt-3 fw-bold text-warning"></div>

      <a href="{{ url_for('home') }}" class="btn btn-link text-info mt-3">‚¨Ö Volver</a>
    </div>
  </div>

<script>
const btnEscanear = document.getElementById("btnEscanear");
const formHuella = document.getElementById("formHuella");
const inputCredential = document.getElementById("inputCredential");
const inputAttestation = document.getElementById("inputAttestation");
const inputSignCount = document.getElementById("inputSignCount");
const alerta = document.getElementById("alerta");

const yaRegistrada = JSON.parse('{{ ya_registrada|tojson }}');

window.addEventListener("DOMContentLoaded", () => {
  if (yaRegistrada) {
    btnEscanear.disabled = true;
    btnEscanear.classList.add("disabled");
    alerta.innerHTML = "‚ö† Ya tienes una huella registrada. No puedes registrar otra.";
    return;
  }
  if (!window.PublicKeyCredential) {
    btnEscanear.disabled = true;
    btnEscanear.classList.add("disabled");
    alerta.innerHTML = "‚ùå Este dispositivo no soporta autenticaci√≥n biom√©trica.";
  }
});

btnEscanear.addEventListener("click", async () => {
  try {
    let challenge = new Uint8Array(32);
    window.crypto.getRandomValues(challenge);

    const credential = await navigator.credentials.create({
      publicKey: {
        challenge: challenge,
        rp: { name: "Mi App Segura" },
        user: {
          id: new TextEncoder().encode("{{ usuario }}"),
          name: "{{ usuario }}",
          displayName: "{{ usuario }}"
        },
        pubKeyCredParams: [{ alg: -7, type: "public-key" }],
        authenticatorSelection: { 
          authenticatorAttachment: "platform", 
          userVerification: "required" 
        },
        timeout: 60000,
        attestation: "direct"
      }
    });

    if (credential) {
      alerta.innerHTML = "‚úÖ Huella detectada correctamente. Ahora puedes guardarla.";

      // Enviar al backend en base64
      inputCredential.value = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
      inputAttestation.value = btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject)));
      inputSignCount.value = 0;

      formHuella.style.display = "block";
      btnEscanear.style.display = "none";
    } else {
      alerta.innerHTML = "‚ùå No se detect√≥ ninguna huella v√°lida.";
    }
  } catch (err) {
    alerta.innerHTML = "‚ö† Error: " + err.message;
  }
});
</script>
</body>
</html>
