<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0f1f, #1a1f2f, #0a0f1f);
      color: #e4e4e4;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      left: -260px;
      top: 0;
      height: 100%;
      width: 260px;
      background: rgba(20, 20, 30, 0.95);
      backdrop-filter: blur(8px);
      color: white;
      transition: all 0.3s ease;
      padding-top: 70px;
      z-index: 1000;
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.6);
    }
    #sidebar.active { left: 0; }
    #sidebar .btn {
      width: 85%;
      margin: 12px auto;
      display: block;
      text-align: center;
      border-radius: 12px;
      font-weight: 500;
      padding: 12px;
      transition: all 0.2s;
    }
    #sidebar .btn:hover {
      transform: translateX(6px) scale(1.02);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
    }

    /* Bot√≥n hamburguesa */
    #sidebarCollapse {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1100;
      background: #1a1f2f;
      border: none;
      color: white;
      font-size: 28px;
      padding: 10px 14px;
      border-radius: 10px;
      transition: 0.3s;
    }
    #sidebarCollapse:hover {
      background: #007bff;
      transform: rotate(90deg);
    }

    /* Contenedor */
    .content {
      margin-left: 0;
      padding: 30px;
      transition: all 0.3s;
    }
    #sidebar.active ~ .content {
      margin-left: 270px;
    }

    /* Tablas */
    .table-container {
      margin-top: 20px;
      overflow-x: auto;
    }

    table {
      border-radius: 12px;
      overflow: hidden;
    }
    thead {
      background: #007bff;
      color: #fff;
    }
    tbody tr {
      transition: all 0.2s;
    }
    tbody tr:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    /* Responsive */
    @media (max-width: 768px) {
      #sidebar { width: 220px; }
      #sidebar.active ~ .content { margin-left: 230px; }
      .content { padding: 15px; }
    }
    @media (max-width: 576px) {
      #sidebar { width: 200px; }
      #sidebar.active ~ .content { margin-left: 200px; }
      #sidebarCollapse { font-size: 24px; padding: 8px 10px; }
    }
  </style>
</head>
<body>

<!-- Bot√≥n-->
<button id="sidebarCollapse">‚ò∞</button>

<!-- Sidebar -->
<div id="sidebar">
  <a href="{{ url_for('home') }}" class="btn btn-danger">Salir</a>
  <button class="btn btn-success" id="showArticulos">Art√≠culos</button>
  <button class="btn btn-primary" id="showInventario">Inventario</button>
  <button class="btn btn-warning" id="showBajas">Historial Inventario</button>
</div>


<!-- Cuadro de b√∫squeda y botones -->
<div class="mb-3 text-center">
  <input type="text" id="searchInput" class="form-control w-50 mx-auto my-3" placeholder="üîé BUSQUEDA" onkeyup="searchTable()">
                {% if rol_id in [1,3,4] %}
  <div class="mt-2">
    <button class="btn btn-success me-2" onclick="downloadTable('excel')">üìä Descargar Excel</button>
    <button class="btn btn-danger" onclick="downloadTable('pdf')">üìÑ Descargar PDF</button>
  </div>
  {% endif %}
</div>
<!-- Contenedor de Notificaciones -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1055;">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="toast align-items-center text-white bg-{{ 'success' if category=='success' else 'danger' if category=='danger' else 'warning' }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
          <div class="d-flex">
            <div class="toast-body">
              {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>
  <!-- Inventario -->
  <div id="inventarioTab" class="table-container">
    <h3 class="text-info text-center my-4">Inventario</h3>
    <div class="table-responsive">
      <table class="table table-dark table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Cantidad</th>
            {% if rol_id in [1,2,3] %}
            <th>Opciones</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for item in inventario %}
          <tr>
            <td>{{ item.id }}</td>
            <td>{{ item.nombre }}</td>
            <td>{{ item.descripcion }}</td>
            <td>{{ item.cantidad }}</td>
            <td>
              {% if rol_id in [1,2,3] %}
              <!-- Bot√≥n para abrir modal -->
              <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar{{ item.id }}">
                ‚ûï
              </button>
              <!-- Bot√≥n Eliminar -->
              <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalEliminar1{{ item.id }}">
                üóëÔ∏è
              </button>
              {% endif %}
            </td>
          </tr>
          <!-- Modal Eliminar Inventario -->
          <div class="modal fade" id="modalEliminar1{{ item.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                  <h5 class="modal-title">Eliminar inventario - {{ item.nombre }}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="{{ url_for('inventario.eliminar_inventario') }}" method="POST">
                  <div class="modal-body">
                    <input type="hidden" name="idarticulo" value="{{ item.id }}">
                    <div class="mb-3">
                      <label class="form-label">Cantidad a eliminar</label>
                      <input type="number" class="form-control" name="cantidad" min="1" max="{{ item.cantidad }}" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Motivo</label>
                      <input type="text" class="form-control" name="motivo" required>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!-- Modal Agregar Inventario -->
           
          <div class="modal fade" id="modalAgregar{{ item.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                  <h5 class="modal-title">Agregar inventario - {{ item.nombre }}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="{{ url_for('inventario.agregar_inventario') }}" method="POST">
                  <div class="modal-body">
                    <input type="hidden" name="idarticulo" value="{{ item.id }}">
                    <div class="mb-3">
                      <label class="form-label">Cantidad</label>
                      <input type="number" class="form-control" name="cantidad" min="1" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Motivo</label>
                      <input type="text" class="form-control" name="motivo" required>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>


 <!-- Art√≠culos -->
<div id="articulosTab" class="table-container" style="display:none;">
  <h3 class="text-success text-center my-4">Art√≠culos</h3>
  <div class="text-center mb-3">
    {% if rol_id in [1,2,3] %}
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgregarArticulo">
      ‚ûï Agregar Art√≠culo
    </button>
    {% endif %}
  </div>
  <div class="table-responsive">
    <table class="table table-dark table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Descripci√≥n</th>
          {% if rol_id in [1,2,3] %}
          <th>Opciones</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for item in articulos %}
        <tr>
          <td>{{ item.id }}</td>
          <td>{{ item.nombre }}</td>
          <td>{{ item.descripcion }}</td>
          {% if rol_id in [1,3] %}
          <td>
            <!-- Editar -->
            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalEditar2{{ item.id }}">
              ‚úèÔ∏è
            </button>
            <!-- Eliminar -->
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalEliminar2{{ item.id }}">
              üóëÔ∏è
            </button>
          </td>
          {% endif %}
        </tr>

        <!-- Modal Editar Art√≠culo -->
        <div class="modal fade" id="modalEditar2{{ item.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
              <div class="modal-header">
                <h5 class="modal-title">Editar Art√≠culo - {{ item.nombre }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <form action="{{ url_for('inventario.actualizar_articulo') }}" method="POST">
                <div class="modal-body">
                  <input type="hidden" name="id" value="{{ item.id }}">
                  <div class="mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-control" name="nombre" value="{{ item.nombre }}" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-control" name="descripcion" required>{{ item.descripcion }}</textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-warning">Actualizar</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Modal Eliminar -->
    <div class="modal fade" id="modalEliminar2{{ item.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title">Eliminar Art√≠culo - {{ item.nombre }}</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <form action="{{ url_for('inventario.eliminar_articulo') }}" method="POST">
            <div class="modal-body">
              <input type="hidden" name="id" value="{{ item.id }}">
              <p>¬øEst√°s seguro de eliminar este art√≠culo? ‚ö†Ô∏è</p>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-danger">Eliminar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Agregar Art√≠culo -->
<div class="modal fade" id="modalAgregarArticulo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Nuevo Art√≠culo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('inventario.agregar_articulo') }}" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="nombre" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-control" name="descripcion" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Agregar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- HISTORIAL INV -->
<div id="bajasTab" class="table-container" style="display:none;">
  <h3 class="text-warning text-center my-4">Historial Inventario</h3>
  <div class="table-responsive">
    <table class="table table-dark table-striped table-hover align-middle" id="tablaBajas">
      <thead>
        <tr>
          <th>ID</th>
          <th>ID Articulo</th>
          <th>Nombre</th>
          <th>Cantidad</th>
          <th>TIPO</th>
          <th>Descripci√≥n</th>            
          <th>Fecha Baja</th>
          {% if rol_id in [1,3] %}
          <th>Opciones</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for item in bajas %}
        <tr>
          <td>{{ item.id }}</td>
          <td>{{ item.idarticulo }}</td>
          <td>{{ item.nombre }}</td>
          <td>{{ item.cantidad }}</td>
          <td>{{ item.tipo }}</td>            
          <td>{{ item.descripcion }}</td>
          <td>{{ item.fecha }}</td>
          <td>
            {% if rol_id in [1,3] %}
            <!-- Bot√≥n Editar -->
            <button class="btn btn-sm btn-warning btn-editar" data-id="{{ item.id }}" data-tipo="{{ item.tipo }}" data-cantidad="{{ item.cantidad }}" data-descripcion="{{ item.descripcion }}">‚úèÔ∏è</button>
            <!-- Bot√≥n Eliminar -->
            <button class="btn btn-sm btn-danger btn-eliminar" data-id="{{ item.id }}" data-tipo="{{ item.tipo }}">üóëÔ∏è</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Editar Historial -->
<div class="modal fade" id="modalEditarHistorial" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Editar Historial</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formEditarHistorial" method="POST" action="{{ url_for('inventario.editar_historial') }}">
        <div class="modal-body">
          <input type="hidden" name="id" id="edit-id">
          <input type="hidden" name="tipo" id="edit-tipo">
          <div class="mb-3">
            <label for="edit-cantidad" class="form-label">Cantidad</label>
            <input type="number" class="form-control" id="edit-cantidad" name="cantidad" min="0" required>
          </div>
          <div class="mb-3">
            <label for="edit-descripcion" class="form-label">Descripci√≥n</label>
            <textarea class="form-control" id="edit-descripcion" name="descripcion" rows="2" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-warning">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Eliminar Historial -->
<div class="modal fade" id="modalEliminarHistorial" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Eliminar Registro</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formEliminarHistorial" method="POST" action="{{ url_for('inventario.eliminar_historial') }}">
        <div class="modal-body">
          <p>¬øEst√°s seguro de eliminar este registro? Esta acci√≥n se registrar√° en bajas.</p>
          <input type="hidden" name="id" id="delete-id">
          <input type="hidden" name="tipo" id="delete-tipo">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Inicializar toasts
  const toastElList = [].slice.call(document.querySelectorAll('.toast'))
  const toastList = toastElList.map(toastEl => new bootstrap.Toast(toastEl))
  toastList.forEach(toast => toast.show())

  // Abrir modal Editar
  document.querySelectorAll('.btn-editar').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id
      const tipo = btn.dataset.tipo
      const cantidad = btn.dataset.cantidad
      const descripcion = btn.dataset.descripcion

      document.getElementById('edit-id').value = id
      document.getElementById('edit-tipo').value = tipo
      document.getElementById('edit-cantidad').value = cantidad
      document.getElementById('edit-descripcion').value = descripcion

      new bootstrap.Modal(document.getElementById('modalEditarHistorial')).show()
    })
  })

  // Abrir modal Eliminar
  document.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id
      const tipo = btn.dataset.tipo
      document.getElementById('delete-id').value = id
      document.getElementById('delete-tipo').value = tipo
      new bootstrap.Modal(document.getElementById('modalEliminarHistorial')).show()
    })
  })
})
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const sidebar = document.getElementById('sidebar');
  const btnToggle = document.getElementById('sidebarCollapse');
  const inventarioTab = document.getElementById('inventarioTab');
  const articulosTab = document.getElementById('articulosTab');
  const bajasTab = document.getElementById('bajasTab');

  btnToggle.addEventListener('click', () => {
    sidebar.classList.toggle('active');
  });

  document.getElementById('showInventario').addEventListener('click', () => {
    inventarioTab.style.display = 'block';
    articulosTab.style.display = 'none';
    bajasTab.style.display = 'none';
  });

  document.getElementById('showArticulos').addEventListener('click', () => {
    inventarioTab.style.display = 'none';
    articulosTab.style.display = 'block';
    bajasTab.style.display = 'none';
  });

  document.getElementById('showBajas').addEventListener('click', () => {
    inventarioTab.style.display = 'none';
    articulosTab.style.display = 'none';
    bajasTab.style.display = 'block';
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var toastElList = [].slice.call(document.querySelectorAll('.toast'))
    var toastList = toastElList.map(function (toastEl) {
      return new bootstrap.Toast(toastEl, { autohide: true })
    })
    toastList.forEach(toast => toast.show())
  });
</script>

<script>
  function searchTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const containers = document.querySelectorAll(".table-container");
    let visibleTab = null;

    // Detectar el contenedor visible
    containers.forEach(container => {
      if (window.getComputedStyle(container).display !== "none") {
        visibleTab = container.querySelector("tbody");
      }
    });

    if (!visibleTab) return;

    const rows = visibleTab.getElementsByTagName("tr");
    for (let i = 0; i < rows.length; i++) {
      let rowText = rows[i].textContent.toLowerCase();
      rows[i].style.display = rowText.includes(input) ? "" : "none";
    }
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
<script>
  document.addEventListener('hidden.bs.modal', function (event) {
    // 1. Resetear el formulario para limpiar campos
    const form = event.target.querySelector("form");
    if (form) {
      form.reset();
    }

    // 2. Quitar el foco de cualquier elemento dentro del modal
    if (document.activeElement && event.target.contains(document.activeElement)) {
      document.activeElement.blur();
    }
  });
</script>

<script>
  function getVisibleTable() {
    const containers = document.querySelectorAll(".table-container");
    for (let container of containers) {
      if (window.getComputedStyle(container).display !== "none") {
        return container.querySelector("table");
      }
    }
    return null;
  }

  function downloadTable(type) {
    const table = getVisibleTable();
    if (!table) {
      alert("‚ö†Ô∏è No hay ninguna tabla visible.");
      return;
    }

    if (type === "excel") {
      let wb = XLSX.utils.book_new();
      let ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, "Datos");
      XLSX.writeFile(wb, "tabla.xlsx");
    }

    if (type === "pdf") {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.autoTable({ html: table });
      doc.save("tabla.pdf");
    }
  }
</script>
</body>
</html>
